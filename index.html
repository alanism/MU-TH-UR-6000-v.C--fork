<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSP: offline-first + blocks exfiltration -->
  <meta http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      script-src 'self';
      style-src 'self' 'unsafe-inline';
      img-src 'self' data:;
      font-src 'self';
      worker-src 'self';
      connect-src 'none';
      base-uri 'none';
      form-action 'none';
    ">

  <title>MSF FIELD TELEMETRY // LOCAL</title>

  <!-- LOCAL ASSETS ONLY (no Google Fonts/CDNs) -->
  <link rel="stylesheet" href="./fonts/space-mono.css" />

  <style>
    :root{
      --bg-color:#050505;
      --panel-bg:#0a0a0a;
      --grid-color:#1a1a1a;
      --border-color:#333;
      --text-main:#a8a8a8;
      --text-dim:#666;
      --accent:#d4d4d4;
      --success:#33ff00;
      --alert:#ff3300;
      --processing:#3b82f6;
      --synthetic:#f59e0b;
      --font-mono:'Space Mono', monospace;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      padding:0;
      background-color:var(--bg-color);
      color:var(--text-main);
      font-family:var(--font-mono);
      height:100vh;
      width:100vw;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      -webkit-font-smoothing:none;
      transition:background-color .3s,color .3s;
    }

    /* FIELD VISIBILITY MODE (High Contrast) */
    body.field-mode{
      --bg-color:#000;
      --panel-bg:#111;
      --text-main:#fff;
      --text-dim:#aaa;
      --border-color:#666;
      --grid-color:#444;
    }
    body.field-mode .scanlines::before{ display:none; }

    /* LAYOUT UTILS */
    .flex{ display:flex; }
    .flex-col{ flex-direction:column; }
    .items-center{ align-items:center; }
    .justify-center{ justify-content:center; }
    .justify-between{ justify-content:space-between; }
    .justify-end{ justify-content:flex-end; }
    .gap-2{ gap:.5rem; }
    .gap-4{ gap:1rem; }
    .p-2{ padding:.5rem; }
    .p-4{ padding:1rem; }
    .p-6{ padding:1.5rem; }
    .mt-2{ margin-top:.5rem; }
    .h-full{ height:100%; }
    .w-full{ width:100%; }
    .relative{ position:relative; }
    .absolute{ position:absolute; }
    .inset-0{ top:0; right:0; bottom:0; left:0; }
    .z-50{ z-index:50; }
    .z-100{ z-index:100; }
    .hidden{ display:none !important; }

    /* Screen Reader Only */
    .sr-only{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }

    /* TYPOGRAPHY */
    .uppercase{ text-transform:uppercase; }
    .font-bold{ font-weight:700; }
    .text-sm{ font-size:.875rem; }
    .text-xs{ font-size:.75rem; }
    .mb-4{ margin-bottom:1rem; }
    .mb-6{ margin-bottom:1.5rem; }
    .pb-2{ padding-bottom:.5rem; }
    .border-b{ border-bottom-width:1px; }
    .text-white{ color:#fff; }
    .text-dim{ color:var(--text-dim); }
    .text-processing{ color:var(--processing); }
    .text-success{ color:var(--success); }
    .border-color{ border-color:var(--border-color); }
    .bg-black-80{ background-color:rgba(0,0,0,.9); }

    /* HEADER */
    header{
      height:48px;
      border-bottom:1px solid var(--border-color);
      padding:0 16px;
      flex-shrink:0;
    }
    h1{
      font-size:1.125rem;
      font-weight:700;
      letter-spacing:-.05em;
      color:#fff;
      margin:0;
    }
    .separator{ width:1px;height:16px;background:var(--border-color); }

    /* STATUS INDICATORS */
    #status-text{
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.1em;
      font-weight:bold;
      transition:color .3s ease;
      cursor:help;
    }
    #status-text[data-status="IDLE"]{ color:var(--text-main); }
    #status-text[data-status="RECEIVED"]{ color:#fff; }
    #status-text[data-status="PROCESSING"]{ color:var(--processing); animation:pulse 1.5s infinite; }
    #status-text[data-status="VALID"]{ color:var(--success); }
    #status-text[data-status="INVALID"]{ color:var(--alert); }

    #file-metadata{
      font-size:.75rem;
      color:var(--text-dim);
      text-transform:uppercase;
      border-left:1px solid var(--border-color);
      padding-left:1rem;
    }

    .verified-badge{
      background:rgba(51,255,0,.1);
      border:1px solid var(--success);
      color:var(--success);
      font-size:.65rem;
      padding:2px 6px;
      text-transform:uppercase;
      letter-spacing:.05em;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    @keyframes pulse{ 0%,100%{opacity:1} 50%{opacity:.5} }

    /* BUTTONS & INPUTS */
    button,.btn{
      background:transparent;
      border:1px solid transparent;
      color:var(--text-dim);
      font-family:inherit;
      font-size:10px;
      text-transform:uppercase;
      cursor:pointer;
      padding:2px 6px;
    }
    button:hover,.btn:hover{ border-color:var(--border-color); color:#fff; }

    .file-upload-btn{
      background:var(--panel-bg);
      border:1px solid var(--text-dim);
      color:var(--accent);
      padding:4px 12px;
      font-size:.75rem;
      text-transform:uppercase;
      cursor:pointer;
      transition:background .2s,color .2s;
      display:inline-block;
      user-select:none;
    }
    .file-upload-btn:hover{ background:#222;color:#fff;border-color:#fff; }
    .file-upload-btn.disabled{
      opacity:.4;
      pointer-events:none;
      cursor:not-allowed;
      border-style:dashed;
    }

    /* Single Source Input: Hidden */
    #db-input{ display:none; }

    /* MAIN GRID */
    main{
      display:grid;
      grid-template-columns:1fr;
      grid-template-rows:repeat(3,minmax(0,1fr));
      gap:8px;
      padding:8px;
      flex:1;
      min-height:0;
    }
    @media (min-width:768px){ main{ grid-template-columns:repeat(3,1fr); } }
    @media (min-width:1024px){ main{ grid-template-columns:repeat(4,1fr); } }

    /* PANELS */
    .panel{
      border:1px solid var(--border-color);
      background:var(--panel-bg);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position:relative;
    }
    .panel-header{
      background:#111;
      border-bottom:1px solid var(--border-color);
      padding:4px 8px;
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.1em;
      color:var(--text-dim);
      display:flex;
      justify-content:space-between;
    }
    .chart-container{
      flex:1;width:100%;height:100%;
      position:relative;padding:8px;
    }

    /* Universal Grid Span */
    .col-span-full{ grid-column:1 / -1; }
    .row-span-2{ grid-row:span 2; }

    /* CRT EFFECT */
    .scanlines::before{
      content:" ";
      display:block;
      position:absolute;
      inset:0;
      background:
        linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,.25) 50%),
        linear-gradient(90deg, rgba(255,0,0,.06), rgba(0,255,0,.02), rgba(0,0,255,.06));
      z-index:50;
      background-size:100% 2px, 3px 100%;
      pointer-events:none;
    }

    /* OVERLAYS */
    #intro-overlay,#processing-indicator{
      background:rgba(0,0,0,.85);
      backdrop-filter:blur(4px);
    }
    .modal{
      border:1px solid var(--border-color);
      background:var(--panel-bg);
      max-width:32rem;
      width:100%;
      padding:1.5rem;
      box-shadow:0 25px 50px -12px rgba(0,0,0,.25);
    }

    /* CHART ELEMENTS */
    .chart-axis text{ fill:var(--text-dim); font-family:var(--font-mono); font-size:10px; }
    .chart-axis line,.chart-axis path{ stroke:#222; }
    body.field-mode .chart-axis line{ stroke:#444; }

    /* FOOTER */
    footer{
      height:24px;
      border-top:1px solid var(--border-color);
      background:#050505;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 16px;
      font-size:10px;
      color:var(--text-dim);
      z-index:60;
    }
    .blinking-cursor::after{
      content:'█';
      animation:blink 1s step-end infinite;
      margin-left:4px;
      color:var(--accent);
    }
    @keyframes blink{ 50%{opacity:0} }
  </style>

  <!-- LOCAL D3 LOAD (no CDN; avoids CSP/eval issues from external sources) -->
  <script src="./lib/d3.v7.min.js" defer></script>
</head>

<body class="scanlines">
  <!-- SINGLE SOURCE INPUT (Hidden) -->
  <input type="file" id="db-input" accept=".db,.sqlite,.sqlite3" />

  <!-- INTRO OVERLAY -->
  <div id="intro-overlay" class="absolute inset-0 z-100 flex items-center justify-center">
    <div class="modal">
      <h2 class="text-white font-bold mb-4 uppercase border-b border-color pb-2">
        Program Telemetry // Local Console
      </h2>

      <div class="text-dim text-sm mb-6" style="margin-bottom:1.5rem;">
        <p class="mb-4">
          <strong class="text-white">PURPOSE:</strong>
          Visualize EMR export data for field program review: patient volume, staff load, workflow bottlenecks.
        </p>
        <p class="mb-4">
          <strong class="text-white">DATA PRIVACY:</strong>
          <span class="text-success">SECURE // OFFLINE.</span>
          All processing happens locally on this device. No patient data is transmitted.
        </p>
        <p>
          <strong class="text-white">INSTRUCTIONS:</strong>
          Select a SQLite (.db) export file from your local EMR system to begin analysis.
        </p>
      </div>

      <div class="flex justify-end">
        <!-- Triggers hidden input -->
        <label for="db-input" class="file-upload-btn">Load EMR Data</label>
      </div>
    </div>
  </div>

  <!-- PROCESSING OVERLAY -->
  <div id="processing-indicator" class="hidden absolute inset-0 z-50 flex items-center justify-center">
    <div class="modal border border-color bg-black-80 p-6" style="text-align:center;">
      <p class="text-processing font-bold uppercase" style="animation:pulse 1.5s infinite;">Analyzing EMR Database Locally</p>
      <p class="text-dim text-xs mt-2 uppercase">No data leaves this device</p>
    </div>
  </div>

  <!-- TOP BAR -->
  <header class="flex items-center justify-between">
    <div class="flex items-center gap-4">
      <h1>MSF // TELEMETRY</h1>
      <div class="separator"></div>

      <div class="flex items-center gap-4">
        <span id="status-text" data-status="IDLE" title="System Ready" aria-live="polite">
          WAITING FOR DATA INPUT
        </span>

        <span id="file-metadata" class="hidden"></span>

        <span id="verified-badge" class="verified-badge hidden" title="Processed locally; not uploaded anywhere">
          <span style="font-size:8px;">●</span> Data Verified Locally
        </span>
      </div>
    </div>

    <div class="flex items-center gap-4">
      <button id="toggle-field-mode" title="Toggle High Contrast">Field Mode</button>
      <label for="db-input" class="file-upload-btn" id="header-upload-label">Load EMR Data</label>
    </div>
  </header>

  <!-- MAIN GRID -->
  <main>
    <div class="panel col-span-full">
      <div class="panel-header">
        <span>Patient Visits (24H)</span>
        <span>COUNT</span>
      </div>
      <div id="desc-visits" class="sr-only">Line chart showing patient visit volume over the last 24 hours.</div>
      <div id="chart-visits" class="chart-container" role="img" aria-describedby="desc-visits"></div>
    </div>

    <div class="panel row-span-2">
      <div class="panel-header">
        <span>Staff Workload by Role</span>
        <span>EVENTS</span>
      </div>
      <div id="desc-workload" class="sr-only">Horizontal bar chart showing activity counts per staff member.</div>
      <div id="chart-operators" class="chart-container" style="overflow-y:auto;overflow-x:hidden;" role="img" aria-describedby="desc-workload"></div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <span>Avg Visit Duration</span>
        <span>MIN</span>
      </div>
      <div id="desc-duration" class="sr-only">Sparkline chart showing trends in patient visit duration.</div>
      <div id="chart-duration" class="chart-container" role="img" aria-describedby="desc-duration"></div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <span>Workflow Status</span>
        <span>%</span>
      </div>
      <div id="desc-states" class="sr-only">Bar chart showing the distribution of patient workflow statuses.</div>
      <div id="chart-states" class="chart-container" role="img" aria-describedby="desc-states"></div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <span>Activity Rate</span>
        <span>Hz</span>
      </div>
      <div id="desc-rate" class="sr-only">Histogram showing system activity frequency.</div>
      <div id="chart-volume" class="chart-container" role="img" aria-describedby="desc-rate"></div>
    </div>
  </main>

  <footer>
    <div class="uppercase">Local Processing Active <span class="blinking-cursor"></span></div>
    <div>BUILD 2024.10.27-MSF // OFFLINE READY</div>
  </footer>

  <!-- APP MODULE -->
  <script type="module" src="./app.js"></script>
</body>
</html>